<!DOCTYPE html>
<html>
  <head>
    {% load static %}
    <script src="https://unpkg.com/htmx.org@1.8.4"></script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
    <script src="{% static 'js/charts.js' %}" defer></script>
    <title>Analys</title>
    <link rel="stylesheet" href="{% static 'css/main.css' %}" />
  </head>
  <body>
    <div class="main-container">
      {% include "topbar.html" with pagetitle="Analys"%}
      <div class="analysis-title">
        <div id="filterBar">
          <strong>Filter:</strong>
          <span id="pillContainer">
          </span>
          <form method="get" action="{% url 'analysis' %}">
            <select name="group_id" onchange="this.form.submit()">
              <option value="">— Välj grupp —</option>
              {% for group in user.survey_groups.all %}
                <option value="{{ group.id }}" {% if group.id|stringformat:"s" == request.GET.group_id %}selected{% endif %}>
                  {{ group.name }}
                </option>
              {% endfor %}
            </select>
          </form>
        </div>
        <div class="time-period-container">
          <!-- Filter for time period -->
          Time period
        </div>

        <div>
          <p>answerd surveys: {{ amount }}</p>
          <p>Deadline: {{ deadline }}</p>
        </div>
        
      </div>

      <div class="analysis-container">
        <div class="analysis-item ratio-5-1">
          <div class="analysis-item-title">
            <h2><b>eNPS</b></h2>
          </div>
          <div class="gauge-container">
            <canvas id="enpsGauge"></canvas>
          </div>
          <div class="graph-container">
            <canvas id="enpsBar"></canvas>
          </div>
        </div>

        <div class="analysis-item ratio-1-1">
          <div class="analysis-item-title">
            <h2><b>Svarsfrekvens</b></h2>
          </div>
          <div class="graph-container">
            <canvas id="canvas" width="400" height="400"></canvas>
          </div>
        </div>

        <div class="analysis-item ratio-2-1">
          <div class="analysis-item-title">
            <h2><b>Analysera fråga</b></h2>
          </div>
          <div class="graph-container" style="height: 90%">
            <canvas id="enpsChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <script>
      document
        .getElementById("groupDropdown")
        .addEventListener("change", function () {
          const select = this;
          const val = select.value;
          const text = select.options[select.selectedIndex].text;
          if (!val) return; // första “Välj grupp”
          // Skippa om redan valt
          if (document.getElementById("pill-" + val)) {
            select.value = "";
            return;
          }
          // Bygg piller‐span
          const pill = document.createElement("span");
          pill.id = "pill-" + val;
          pill.textContent = text + " ";
          // kryss‐knapp
          const btn = document.createElement("button");
          btn.type = "button";
          btn.textContent = "×";
          btn.onclick = () => pill.remove();
          pill.appendChild(btn);
          // lägg in i containern
          document.getElementById("pillContainer").appendChild(pill);
          // nollställ dropdown
          select.value = "";
        });
    </script>


<script>
  const enpsGaugeData   = {{ enpsScore        |default:"0"  |safe }};
  const enpsBarLabels   = {{ slider_values    |default:"[]" |safe }};
  const enpsBarData     = {{ enpsDistribution |default:"[]" |safe }};
  const pieLabels       = {{ enpsPieLabels    |default:"[]" |safe }};
  const pieData         = {{ enpsPieData      |default:"[]" |safe }};
  const enpsDate        = "{{ deadline|default:'' }}";
  const answerData     = {{ answer_pct|default:"0" }};
  
  const enpsDataChange  = 0;            // Hur ska detta hämtas??
  const answerChange    = 0;              // placeholder
  const pieColors       = ["rgb(140,214,16)","rgb(16,23,214)","rgb(16,191,214)"];
  
  function safeInit(fn, id, ...args) {
    const canvas = document.getElementById(id);
    if (!canvas) return;                       // canvas saknas (t.ex. ingen data)
    if (canvas._chartInstance) {               // chart finns – ta bort
        canvas._chartInstance.destroy();
        canvas._chartInstance = null;
    }
    const chart = fn(id, ...args); 
    canvas._chartInstance = chart;
  }
  
  document.addEventListener("DOMContentLoaded", function () {
    if (enpsBarLabels.length === 0) return;
  
    safeInit(initEnpsGauge, "enpsGauge", enpsGaugeData, enpsDataChange, enpsDate);
    safeInit(initEnpsBar,   "enpsBar",   enpsBarLabels, enpsBarData);
    safeInit(initAnswerFrequency, "canvas", answerData, answerChange);
    safeInit(initBarChart,  "enpsChart", pieLabels, pieData, pieColors);
  });
  </script>
  
  </body>
</html>
