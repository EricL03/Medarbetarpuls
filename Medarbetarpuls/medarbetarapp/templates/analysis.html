<!DOCTYPE html>
<html>
  <head>
    {% load static %}
    <script src="https://unpkg.com/htmx.org@1.8.4"></script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
    <script src="{% static 'js/charts.js' %}" defer></script>
    <title>Analys</title>
    <link rel="stylesheet" href="{% static 'css/main.css' %}" />
  </head>
  <body>
    <div class="main-container">
      {% include "topbar.html" with pagetitle="Analys"%}
      <!-- Go back button-->
      <button
        class="image-button"
        onclick="navigateBack('{{user.user_role}}')"
      >
        <img
          src="{% static 'images/go-back-btn.png' %}"
          alt="Gå Tillbaka"
          class="back-icon"
        />
      </button>

      <div class="analysis-title">
          <!-- Filter for work-group -->
          <div id="filterBar">
            <strong>Välj grupp:</strong>
            <span id="pillContainer"></span>
            <form method="get" action="{% url 'analysis' %}">
              <input type="hidden" name="surveys" value="{{ request.GET.surveys }}">
              <select id="groupDropdown" name="group_id" onchange="this.form.submit()">
                {% for group in user.survey_groups.all %}
                  <option value="{{ group.id }}" {% if group.id|stringformat:"s" == request.GET.group_id %}selected{% endif %}>
                    {{ group.name }}
                  </option>
                {% endfor %}
              </select>
            </form>
          </div>

      <!-- Filter for users -->
      <div id="filterBar">
        <strong>Välj användare:</strong>
        <form method="get" action="{% url 'analysis' %}">
          <input type="hidden" name="group_id"    value="{{ request.GET.group_id }}">
          <input type="hidden" name="surveys"     value="{{ request.GET.surveys }}">
          <input type="hidden" name="question_id" value="{{ request.GET.question_id }}">
          <select name="user_id" onchange="this.form.submit()">
            <option value="">— Välj användare —</option>
            {% for label, user in respondents.items %}
              <option value="{{ label }}" {% if label == selected_user_id %}selected{% endif %}>
                {{ label }}
              </option>
            {% endfor %}
          </select>
        </form>
      </div>

      <!-- Filter for question-bank questions -->
      <div id="filterBar">
        <strong>Välj bankfråga:</strong>
        <form method="get" action="{% url 'analysis' %}">
          <input type="hidden" name="group_id" value="{{ request.GET.group_id }}">
          <input type="hidden" name="surveys"  value="{{ request.GET.surveys }}">
          <input type="hidden" name="user_id"  value="{{ request.GET.user_id }}">
          <select name="question_id" onchange="this.form.submit()">
            <option value="">— Välj fråga —</option>
            {% for question in bank_questions %}
              <option value="{{ question.id }}" {% if question.id|stringformat:"s" == selected_question_id %}selected{% endif %}>
                {{ question.question }}
              </option>
            {% endfor %}
          </select>
        </form>
      </div>

      <!-- Filter for time period -->
      <div class="time-period-container">
        <strong>Antal enkäter:</strong>
          <div
            class="flex space-x-2 bg-gray-100 p-2 rounded-md"
            id="time-filter"
          >
          <input type="hidden" name="group_id"   value="{{ request.GET.group_id }}">
          <input type="hidden" name="user_id"    value="{{ request.GET.user_id }}">
          <input type="hidden" name="question_id" value="{{ request.GET.question_id }}">
          {% for label, value in survey_ranges %}
          <!-- Add comment here to explain the href-->
          <a
          href="?group_id={{ request.GET.group_id }}{% if request.GET.user_id %}&user_id={{ request.GET.user_id }}{% endif %}{% if request.GET.question_id %}&question_id={{ request.GET.question_id }}{% endif %}&surveys={{ value }}"
          class="px-3 py-1 rounded-md text-sm font-medium {% if value == selected_survey_range %}bg-blue-500 text-white{% else %}bg-blue-100 text-blue-900{% endif %}"
        >
          {{ label }}
        </a>       
        {% endfor %} 
          </div>
        </div>
      </div>

      <!-- Analysis items (answer frequency, enps, distribution)
           when no specific question is choosen -->
      <div class="analysis-container">
        {% if selected_question_format == None %}
        <div class="analysis-item ratio-2-1">
          <div class="analysis-item-title"><h2><b>Svarsfrekvens över tid</b></h2></div>
          <div class="graph-container" style="height: 90%">
            <canvas id="answerFrequencyTrend"></canvas>
          </div>
        </div>
        <div class="analysis-item ratio-1-1">
          <div class="analysis-item-title"><h2><b>Svarsfrekvens</b></h2></div>
          <div class="graph-container">
            <canvas id="responseRateGauge" width="400" height="400"></canvas>
          </div>
        </div>
        <div class="analysis-item ratio-1-1">
          <div class="analysis-item-title"><h2><b>eNPS</b></h2></div>
          <div class="graph-container">
            <canvas id="enpsGauge" width="400" height="400"></canvas>
          </div>
        </div>
        <div class="analysis-item ratio-2-1">
          <div class="analysis-item-title"><h2><b>Svarsuppdelning på frågor</b></h2></div>
          <div class="graph-container" style="height: 90%">
            <canvas id="answerDistributionQuestions"></canvas>
          </div>
        </div>

        <!-- analysis items (answer frequency, distribution) for enps -->
        {% elif selected_question_format == "enps" %}
        <div class="analysis-item ratio-5-1">
          <div class="analysis-item-title"><h2><b>eNPS</b></h2></div>
          <div class="gauge-container"><canvas id="enpsGauge"></canvas></div>
          <div class="graph-container"><canvas id="enpsBar"></canvas></div>
        </div>
        <div class="analysis-item ratio-1-1">
          <div class="analysis-item-title"><h2><b>Svarsfrekvens</b></h2></div>
          <div class="graph-container">
            <canvas id="responseRateGauge" width="400" height="400"></canvas>
          </div>
        </div>
        <div class="analysis-item ratio-2-1">
          <div class="analysis-item-title"><h2><b>Analysera fråga</b></h2></div>
          <div class="graph-container" style="height: 90%">
            <canvas id="enpsPieChart"></canvas>
          </div>
        </div>

        <!-- Analysis items (answer frequency, distribution) for slider -->
        {% elif selected_question_format == "slider" %}
        <div class="analysis-item ratio-2-1">
          <div class="analysis-item-title"><h2><b>Svarsfördelning slider</b></h2></div>
          <div class="graph-container" style="height: 90%">
            <canvas id="barChartSlider"></canvas>
          </div>
        </div>
        <div class="statistics-container">
          <div class="analysis-item ratio-1-4">
            <div class="analysis-item-title"><h2><b>Medel</b></h2></div>
            <div class="graph-container flex flex-col items-center justify-center text-sm">
              <p>{{ slider_mean }}</p>
            </div>
          </div>
        
          <div class="analysis-item ratio-1-4">
            <div class="analysis-item-title"><h2><b>Std.avv</b></h2></div>
            <div class="graph-container flex flex-col items-center justify-center text-sm">
              <p>{{ slider_std}}</p>
            </div>
          </div>
        
          <div class="analysis-item ratio-1-4">
            <div class="analysis-item-title"><h2><b>V.Koeff</b></h2></div>
            <div class="graph-container flex flex-col items-center justify-center text-sm">
              <p>{{ slider_cv}}</p>
            </div>
          </div>
        
          <div class="analysis-item ratio-1-4">
            <div class="analysis-item-title"><h2><b>Median</b></h2></div>
            <div class="graph-container flex flex-col items-center justify-center text-sm">
              <p>{{ slider_cv}}</p>
            </div>
          </div>
        </div>
      
        <div class="analysis-item ratio-1-1">
          <div class="analysis-item-title"><h2><b>Svarsfrekvens</b></h2></div>
          <div class="graph-container">
            <canvas id="responseRateGauge" width="400" height="400"></canvas>
          </div>
        </div>
        <div class="analysis-item ratio-2-1">
          <div class="analysis-item-title"><h2><b>Historik</b></h2></div>
          <div class="graph-container" style="height: 90%">
            <canvas id="lineTrendChartSlider"></canvas>
          </div>
        </div>
        
        <!-- Analysis items (mean, std variation, variance, median) for multiplechoice -->
        {% elif selected_question_format == "multiplechoice" %}
        <div class="analysis-item ratio-2-1">
          <div class="analysis-item-title"><h2><b>Svarsfördelning Multiple Choice</b></h2></div>
          <div class="graph-container" style="height: 90%">
            <canvas id="barChartMultipleChoice"></canvas>
          </div>
        </div>

        <div class="statistics-container">
          <div class="analysis-item ratio-1-4">
            <div class="analysis-item-title"><h2><b>Medel</b></h2></div>
            <div class="graph-container flex flex-col items-center justify-center text-sm">
              <p>{{ slider_mean }}</p>
            </div>
          </div>
        
          <div class="analysis-item ratio-1-4">
            <div class="analysis-item-title"><h2><b>Std.avv</b></h2></div>
            <div class="graph-container flex flex-col items-center justify-center text-sm">
              <p>{{ slider_std}}</p>
            </div>
          </div>
        
          <div class="analysis-item ratio-1-4">
            <div class="analysis-item-title"><h2><b>V.Koeff</b></h2></div>
            <div class="graph-container flex flex-col items-center justify-center text-sm">
              <p>{{ slider_cv}}</p>
            </div>
          </div>
        
          <div class="analysis-item ratio-1-4">
            <div class="analysis-item-title"><h2><b>Median</b></h2></div>
            <div class="graph-container flex flex-col items-center justify-center text-sm">
              <p>{{ slider_cv}}</p>
            </div>
          </div>
        </div>
        
          <div class="analysis-item ratio-1-1">
            <div class="analysis-item-title"><h2><b>Svarsfrekvens</b></h2></div>
            <div class="graph-container">
              <canvas id="responseRateGauge" width="400" height="400"></canvas>
            </div>
          </div>
          <div class="analysis-item ratio-2-1">
            <div class="analysis-item-title"><h2><b>Fördelning av val</b></h2></div>
            <div class="graph-container" style="height: 90%">
              <canvas id="barChartMultipleChoice"></canvas>
            </div>
          </div>

        <!-- Analysis items (answer frequency, distribution) for yes/no -->
        {% elif selected_question_format == "yesno" %}
          <div class="analysis-item ratio-2-1">
            <div class="analysis-item-title"><h2><b>Ja/Nej-resultat</b></h2></div>
            <div class="graph-container" style="height: 90%">
              <canvas id="yesNoPieChart"></canvas>
            </div>
          </div>

          <div class="analysis-item ratio-1-1">
            <div class="analysis-item-title"><h2><b>Svarsfrekvens</b></h2></div>
            <div class="graph-container">
              <canvas id="responseRateGauge" width="400" height="400"></canvas>
            </div>
          </div>

          <div class="analysis-item ratio-1-1">
            <div class="analysis-item-title"><h2><b>Trend</b></h2></div>
            <div class="graph-container">
              <canvas id="yesNoTrend" width="400" height="400"></canvas>
            </div>
          </div>

          <div class="analysis-item ratio-1-1">
            <div class="analysis-item-title"><h2><b>Svarsfrekvens</b></h2></div>
            <div class="graph-container">
              <canvas id="yesNoFrequency" width="400" height="400"></canvas>
            </div>
          </div>
          <div class="statistics-container">
            <div class="analysis-item ratio-1-4">
              <div class="analysis-item-title"><h2><b>Medel</b></h2></div>
              <div class="graph-container flex flex-col items-center justify-center text-sm">
                <p>{{ slider_mean }}</p>
              </div>
            </div>
          
            <div class="analysis-item ratio-1-4">
              <div class="analysis-item-title"><h2><b>Std.avv</b></h2></div>
              <div class="graph-container flex flex-col items-center justify-center text-sm">
                <p>{{ slider_std}}</p>
              </div>
            </div>
          
            <div class="analysis-item ratio-1-4">
              <div class="analysis-item-title"><h2><b>V.Koeff</b></h2></div>
              <div class="graph-container flex flex-col items-center justify-center text-sm">
                <p>{{ slider_cv}}</p>
              </div>
            </div>
          
            <div class="analysis-item ratio-1-4">
              <div class="analysis-item-title"><h2><b>Median</b></h2></div>
              <div class="graph-container flex flex-col items-center justify-center text-sm">
                <p>{{ slider_cv}}</p>
              </div>
            </div>
          </div>

        <!-- Analysis items (answer frequency) for text -->
        {% elif selected_question_format == "text" %}
        <div class="analysis-item ratio-1-1">
          <div class="analysis-item-title"><h2><b>Svarsfrekvens</b></h2></div>
          <div class="graph-container">
            <canvas id="textResponseRateGauge" width="400" height="400"></canvas>
          </div>
        </div>
        <div class="analysis-item ratio-2-1">
          <div class="analysis-item-title"><h2><b>Fritextsvar</b></h2></div>
          <div class="graph-container" style="height: 90%; overflow-y: scroll;">
            {% for answer in free_text_answers %}
              <p>{{ answer }}</p>
            {% empty %}
              <p>Inga svar tillgängliga.</p>
            {% endfor %}
          </div>
        </div>
        {% endif %}

    <script>
      document
        .getElementById("groupDropdown")
        .addEventListener("change", function () {
          const select = this;
          const val = select.value;
          const text = select.options[select.selectedIndex].text;
          if (!val) return; // första “Välj grupp”
          // Skippa om redan valt
          if (document.getElementById("pill-" + val)) {
            select.value = "";
            return;
          }
          // Bygg piller‐span
          const pill = document.createElement("span");
          pill.id = "pill-" + val;
          pill.textContent = text + " ";
          // kryss‐knapp
          const btn = document.createElement("button");
          btn.type = "button";
          btn.textContent = "×";
          btn.onclick = () => pill.remove();
          pill.appendChild(btn);
          // lägg in i containern
          document.getElementById("pillContainer").appendChild(pill);
          // nollställ dropdown
          select.value = "";
        });
    </script>


  <script>
    function navigateBack(user_role) {
      // The previous URL that linked to this page
      let previousUrl = document.referrer;
        if (previousUrl) {
          if (previousUrl.includes("analysis")) {
            // Avoid redirecting back to this page to prevent an infinite loop
            if (user_role == "surveycreator") {
              previousUrl = "/start-creator/";
            } else {
              previousUrl = "/start-admin/";
            }
          }
          window.location.href = previousUrl;
        } else {
          // Fallback if referrer is empty
          // This simulates the user pressing the back button
          window.history.back();
        }
    }

    // eNPS page
    const enpsGaugeData   = {{ enpsScore        |default:"0"  |safe }};
    const enpsBarLabels   = {{ slider_values    |default:"['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10']" |safe }};
    const enpsBarData     = {{ enpsDistribution |default:"[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]" |safe }};
    const pieLabels       = {{ enpsPieLabels    |default:"['Detractors', 'Passives', 'Promoters']" |safe }};
    const pieData         = {{ enpsPieData      |default:"[0,0,0]" |safe }};
    const enpsDate        = "{{ deadline|default:'####-##-##' }}";
    const answerData      = {{ answer_pct       |default:"0" |safe }};
    const enpsDataChange  = {{ enpsChange       |default:"0" |safe }};
    const answerChange    = {{ answerChange     |default:"0" |safe }};
    const pieColors       = ["rgb(140,214,16)","rgb(16,23,214)","rgb(16,191,214)"];
    
    // General survey page 
    const answerFrequencyTrendLabels = {{ answerFrequencyLabels            |default:"['####-##-##', '####-##-##', '####-##-##']" |safe }};
    const answerFrequencyTrendData   = {{ answerFrequencyData              |default:"[0,0,0]" |safe }};
    const answerDistributionTrendLabels = {{ answerDistributionLabels            |default:"['####-##-##', '####-##-##', '####-##-##']" |safe }};
    const answerDistributionTrendData   = {{ answerDistributionData              |default:"[0,0,0]" |safe }};
    const lineColors = ["rgb(140,214,16)","rgb(16,23,214)"];
    
    
    // Extra bar chart (multiple choice/slider)
    const barChartSlider = {{ slider_values    |default:"['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10']" |safe }};
    const barDataSlider  = {{ sliderDistribution |default:"[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]" |safe }};
    const barChartLabels = {{ barChartLabels    |default:"[]" |safe }};
    const barChartData   = {{ barChartData      |default:"[]" |safe }};
    
    // Yes/No page
    const yesNoLabels    = {{ yesNoLabels       |default:"['Ja', 'Nej']" |safe }};
    const yesNoData      = {{ yesNoData         |default:"[0,0]" |safe }};
    
    // Slider page
    const sliderMean     = {{ slider_mean       |default:"0" |safe }};
    const sliderStd      = {{ slider_std        |default:"0" |safe }};
    const sliderCv       = {{ slider_cv         |default:"0" |safe }};
    const sliderTrendLabels = {{ lineLabels            |default:"['####-##-##', '####-##-##', '####-##-##']" |safe }};
    const sliderTrendData = {{ lineData              |default:"[0,0,0]" |safe }};
    
    // Multiple choice page

    //const multipleChoiceLabels = {{ multipleChoiceLabels  |default:"[#,#,#]" |safe }};
    //const multipleChoiceData = {{ multipleChoiceData  |default:"[0,0,0]" |safe }};


    function safeInit(fn, id, ...args) {
      const canvas = document.getElementById(id);
      if (!canvas) return;                       // If canvas not found
      if (canvas._chartInstance) {               // Canvas found
          canvas._chartInstance.destroy(); // Destroy the previous chart instance to avoid memory leaks
          canvas._chartInstance = null;
      }
      const chart = fn(id, ...args); 
      canvas._chartInstance = chart;
    }
    
    document.addEventListener("DOMContentLoaded", function () {
      if (enpsBarLabels.length === 0) return;

  
        // ENPS
        safeInit(initEnpsGauge,    "enpsGauge",                enpsGaugeData,   enpsDataChange, enpsDate);
        safeInit(initEnpsBar,      "enpsBar",                  enpsBarLabels,   enpsBarData);
        safeInit(initPieChart,      "enpsPieChart",                  pieLabels,   pieData);
        // Svarsfrekvens gauge
        safeInit(initAnswerFrequency, "responseRateGauge",     answerData,      answerChange);
        // General survey
        safeInit(initLineChart,    "answerFrequencyTrend",     answerFrequencyTrendLabels, answerFrequencyTrendData, lineColors);
        safeInit(initBarChart,    "answerDistributionQuestions", answerDistributionTrendLabels, answerDistributionTrendData, lineColors);

        // Slider
        safeInit(initLineChart,    "lineTrendChartSlider",     sliderTrendLabels, sliderTrendData, lineColors);
        safeInit(initBarChart,     "barChartSlider",           barChartSlider,  barDataSlider);

        // Multiple choice
        safeInit(initBarChart,     "barChartMultipleChoice",   barChartLabels,  barChartData);

        // Text
        safeInit(initAnswerFrequency, "textResponseRateGauge",     answerData,      answerChange);

        // YesNo
        safeInit(initPieChart,      "yesNoPieChart",                  yesNoLabels,   yesNoData);
        

        

    });

      // Timer that calls logout form after specified time
      let logoutTimer;
      function resetTimer() {
        clearTimeout(logoutTimer);
        logoutTimer = setTimeout(() => {
          document.getElementById('logout-form').requestSubmit();
          }, 10 * 60 * 1000); // 10 minutes
      }

      window.onload = resetTimer;
      document.onmousemove = resetTimer;
      document.onkeypress = resetTimer;
      document.onscroll = resetTimer;
      document.onclick = resetTimer;

  </script>
  <form id="logout-form" method="post" hx-post="/logout/" hx-target="body" hx-swap="outerHTML" style="display:none;">
    {% csrf_token %}
  </form>
  </body>
</html>
